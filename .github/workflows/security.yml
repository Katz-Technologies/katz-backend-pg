name: Security Scanning

on:
  push:
    branches:
      - main
      - stage
      - dev
  pull_request:
    branches:
      - main
      - stage
      - dev
  schedule:
    # Run weekly security scan
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  dependency-scanning:
    name: Dependency Vulnerability Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate || true
          npm audit --json > npm-audit-report.json || true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || (github.event.before || github.event.repository.default_branch) }}
          head: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || (github.event.after || github.sha) }}
          extra_args: --only-verified
        continue-on-error: true

      - name: Check for hardcoded secrets (grep patterns)
        run: |
          echo "Checking for potential hardcoded secrets..."
          # Check for common secret patterns
          SECRETS_FOUND=0
          
          # Check for API keys, tokens, passwords
          if grep -r -i -E "(api[_-]?key|secret[_-]?key|private[_-]?key|access[_-]?token|password|pwd)\s*[:=]\s*['\"][^'\"]{10,}" \
            --include="*.ts" --include="*.js" --include="*.json" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=coverage \
            --exclude-dir=.git src/ .github/ 2>/dev/null | grep -v "test" | grep -v "spec" | grep -v "example" | grep -v "mock"; then
            echo "⚠️ Warning: Potential hardcoded secrets found"
            SECRETS_FOUND=1
          fi
          
          # Check for AWS keys
          if grep -r -i -E "(aws[_-]?access[_-]?key|aws[_-]?secret[_-]?key)\s*[:=]\s*['\"][^'\"]{10,}" \
            --include="*.ts" --include="*.js" \
            --exclude-dir=node_modules --exclude-dir=dist --exclude-dir=coverage \
            src/ 2>/dev/null; then
            echo "⚠️ Warning: Potential AWS keys found"
            SECRETS_FOUND=1
          fi
          
          if [ $SECRETS_FOUND -eq 0 ]; then
            echo "✅ No obvious hardcoded secrets found"
          else
            echo "⚠️ Review the findings above. Use environment variables or secrets management instead."
            # Don't fail, just warn - trufflehog handles actual secret detection
          fi

  container-scanning:
    name: Container Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner on Dockerfile
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Build Docker image for scanning
        run: |
          docker build -t katz-backend:security-scan .

      - name: Run Trivy on Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'katz-backend:security-scan'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

  code-scanning:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint security plugin
        run: |
          echo "Running security-focused linting..."
          npm run lint || true
          # Additional security checks can be added here

      - name: Check for dangerous patterns
        run: |
          echo "Checking for dangerous code patterns..."
          
          # Check for eval usage
          if grep -r "eval(" --include="*.ts" --include="*.js" src/ 2>/dev/null | grep -v "test" | grep -v "spec"; then
            echo "⚠️ Warning: eval() usage found - potential security risk"
          fi
          
          # Check for dangerous shell execution
          if grep -r -E "(exec|spawn|system)" --include="*.ts" --include="*.js" src/ 2>/dev/null | grep -v "test" | grep -v "spec"; then
            echo "⚠️ Warning: Potentially dangerous shell execution patterns found"
          fi
          
          # Check for SQL injection risks (if using raw queries)
          if grep -r -E "(query|execute).*\+.*\$" --include="*.ts" src/ 2>/dev/null | grep -v "test" | grep -v "spec"; then
            echo "⚠️ Warning: Potential SQL injection risks - use parameterized queries"
          fi
          
          echo "✅ Security pattern check completed"

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check licenses
        run: |
          echo "Checking package licenses..."
          npx license-checker --onlyAllow "MIT;ISC;BSD;Apache-2.0;BSD-2-Clause;BSD-3-Clause" --excludePrivatePackages || true
          # Generate license report
          npx license-checker --json > license-report.json || true

      - name: Upload license report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-report
          path: license-report.json
          retention-days: 30

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [dependency-scanning, secret-scanning, container-scanning, code-scanning, license-compliance]
    if: always()

    steps:
      - name: Security scan summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scanning | ${{ needs.dependency-scanning.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scanning.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scanning | ${{ needs.container-scanning.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Scanning | ${{ needs.code-scanning.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Compliance | ${{ needs.license-compliance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review individual job results for details." >> $GITHUB_STEP_SUMMARY

