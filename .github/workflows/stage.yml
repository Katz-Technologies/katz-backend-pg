name: Deploy to Staging

on:
  push:
    branches:
      - stage
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - stage
  workflow_dispatch:

jobs:
  check-dev-status:
    name: Check dev branch status
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (apt update && apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Check if commit passed CI on dev
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking if latest dev commit passed CI..."
          
          # For PR, get the head branch (should be dev)
          if [ "${{ github.event.pull_request.head.ref }}" = "dev" ]; then
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            echo "PR head commit SHA: $HEAD_SHA"
            
            # Check CI status using GitHub API
            CI_STATUS=$(gh api repos/${{ github.repository }}/commits/$HEAD_SHA/status --jq '.state' 2>/dev/null || echo "unknown")
            
            if [ "$CI_STATUS" = "success" ]; then
              echo "✅ CI passed on dev branch for commit $HEAD_SHA"
            elif [ "$CI_STATUS" = "pending" ]; then
              echo "⚠️ CI is still running on dev branch for commit $HEAD_SHA"
              echo "⚠️ Continuing anyway, but this should be investigated"
            elif [ "$CI_STATUS" = "failure" ] || [ "$CI_STATUS" = "error" ]; then
              echo "❌ CI failed on dev branch for commit $HEAD_SHA"
              echo "❌ Deployment blocked: code must pass CI on dev before deploying to stage"
              exit 1
            else
              echo "⚠️ Could not determine CI status (got: $CI_STATUS)"
              echo "⚠️ Continuing, but this should be verified manually"
            fi
          else
            echo "⚠️ PR is not from dev branch, skipping CI check"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Skip check for push events
        if: github.event_name == 'push'
        run: |
          echo "✅ Push event to stage branch, skipping dev CI check"

  test-and-deploy:
    name: stage - test and deploy
    runs-on: ubuntu-latest
    environment:
      name: staging
    needs: [check-dev-status]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Run tests
        run: npm test -- --watchAll=false

      - name: Build application
        run: npm run build

      - name: Deploy to staging
        if: github.event_name != 'pull_request'
        run: |
          echo "Deploying to staging environment..."
          # Add your deployment logic here

