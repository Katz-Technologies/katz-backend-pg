name: Smoke Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - staging
          - production
      url:
        description: 'Base URL to test'
        required: true
        type: string
        default: 'http://localhost:3000'

jobs:
  smoke-tests:
    name: Smoke Tests - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Health Check
        run: |
          BASE_URL="${{ inputs.url }}"
          echo "Testing health endpoint: ${BASE_URL}/api/health"
          
          # Wait for service to be ready
          MAX_ATTEMPTS=30
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -f -s "${BASE_URL}/api/health" > /dev/null 2>&1; then
              echo "✅ Health check passed on attempt $ATTEMPT"
              break
            fi
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "❌ Health check failed after $MAX_ATTEMPTS attempts"
              exit 1
            fi
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS failed, retrying in 3 seconds..."
            sleep 3
          done
          
          # Get and validate health response
          HEALTH_RESPONSE=$(curl -s "${BASE_URL}/api/health")
          echo "Health response: $HEALTH_RESPONSE"
          
          # Check response structure
          if ! echo "$HEALTH_RESPONSE" | grep -q '"status"'; then
            echo "❌ Invalid health response format"
            exit 1
          fi
          
          # Check status
          STATUS=$(echo "$HEALTH_RESPONSE" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
          echo "Service status: $STATUS"
          
          if [ "$STATUS" = "down" ]; then
            echo "❌ Service is down"
            exit 1
          fi

      - name: Check Redis Service
        run: |
          BASE_URL="${{ inputs.url }}"
          HEALTH_RESPONSE=$(curl -s "${BASE_URL}/api/health")
          
          if echo "$HEALTH_RESPONSE" | grep -q '"redis".*"status":"ok"'; then
            echo "✅ Redis service is healthy"
          else
            echo "⚠️ Redis service may have issues"
            echo "$HEALTH_RESPONSE" | grep -A 2 '"redis"' || echo "Redis status not found in response"
          fi

      - name: Check ClickHouse Service
        run: |
          BASE_URL="${{ inputs.url }}"
          HEALTH_RESPONSE=$(curl -s "${BASE_URL}/api/health")
          
          if echo "$HEALTH_RESPONSE" | grep -q '"clickhouse".*"status":"ok"'; then
            echo "✅ ClickHouse service is healthy"
          else
            echo "⚠️ ClickHouse service may have issues"
            echo "$HEALTH_RESPONSE" | grep -A 2 '"clickhouse"' || echo "ClickHouse status not found in response"
          fi

      - name: Check API Endpoints (if available)
        run: |
          BASE_URL="${{ inputs.url }}"
          
          # Test if API is accessible (basic check)
          echo "Testing API accessibility..."
          
          # Try to access a common endpoint (adjust based on your API)
          # This is a placeholder - add actual endpoint tests
          if curl -f -s "${BASE_URL}/api" > /dev/null 2>&1 || \
             curl -f -s "${BASE_URL}/api/v1" > /dev/null 2>&1; then
            echo "✅ API base endpoint is accessible"
          else
            echo "⚠️ API base endpoint may not be accessible (this might be expected)"
          fi

      - name: Response Time Check
        run: |
          BASE_URL="${{ inputs.url }}"
          
          echo "Checking response times..."
          START_TIME=$(date +%s%N)
          curl -s "${BASE_URL}/api/health" > /dev/null
          END_TIME=$(date +%s%N)
          
          DURATION=$(( (END_TIME - START_TIME) / 1000000 ))
          echo "Health endpoint response time: ${DURATION}ms"
          
          if [ $DURATION -gt 5000 ]; then
            echo "⚠️ Warning: Response time is high (${DURATION}ms > 5000ms)"
          else
            echo "✅ Response time is acceptable (${DURATION}ms)"
          fi

      - name: Generate Smoke Test Report
        if: always()
        run: |
          echo "## Smoke Test Results - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL**: ${{ inputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All smoke tests completed." >> $GITHUB_STEP_SUMMARY

